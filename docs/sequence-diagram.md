# 시퀀스 다이어그램

- 최초 사용자가 진입하는 ~~요청 블록은 application의 행동을 기준으로 작성되었습니다. (Facade)
- 이후 블록은 각 domain의 행동을 기준으로 작성되었습니다. (Service / Model)
- 대기열 토큰 검증 / 유저 정보 검증은 추후 공통화로 application 레이어 진입 전 단계에서 이루어질 수 있습니다.

## 대기열 토큰 발급

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 대기열 토큰 발급 요청: 대기열 토큰 발급 요청
    대기열 토큰 발급 요청 ->>+ 유저: 유저 정보 검증 (application 전 단계)
    opt 유저 존재하지 않음
        유저 -->>- 사용자: 유저 검증 실패
    end

    대기열 토큰 발급 요청 ->>+ 대기열: 대기열 토큰 발급 요청
    대기열 ->>+ 대기열: 대기열 상태 조회 및 토큰 발급
    대기열 -->>- 대기열 토큰 발급 요청: 대기열 토큰 반환
    대기열 토큰 발급 요청 -->>- 사용자: 대기열 토큰 반환
```

## 예약 가능 날짜 조회

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 예약 가능 날짜 조회 요청: 예약 가능 날짜 조회 요청
    예약 가능 날짜 조회 요청 ->>+ 대기열: 대기열 토큰 검증 (application 전 단계)
    opt 예약 불가능 상태
        대기열 -->>- 사용자: 대기열 검증 실패
    end

    예약 가능 날짜 조회 요청 ->>+ 콘서트 일정: 예약 가능 날짜 조회
    콘서트 일정 -->>- 예약 가능 날짜 조회 요청: 예약 가능 날짜 반환
    예약 가능 날짜 조회 요청 -->>- 사용자: 예약 가능 날짜 반환 
```

## 예약 가능 좌석 조회

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 예약 가능 좌석 조회 요청: 예약 가능 좌석 조회 요청
    예약 가능 좌석 조회 요청 ->>+ 대기열: 대기열 토큰 검증 (application 전 단계)
    opt 예약 불가능 상태
        대기열 -->>- 사용자: 대기열 검증 실패
    end

    예약 가능 좌석 조회 요청 ->>+ 콘서트 일정: 예약 가능 좌석 조회 요청
    opt 콘서트 일정 없음
        콘서트 일정 -->> 사용자: 잘못된 요청
    end

    콘서트 일정 ->>+ 콘서트 좌석: 예약 가능 좌석 조회 요청
    콘서트 좌석 ->>+ 예약: 예약 정보 조회
    예약 -->>- 콘서트 좌석: 예약 정보 반환
    콘서트 좌석 -->>- 콘서트 일정: 좌석 중 예약되지 않은 좌석 반환
    콘서트 일정 -->>- 예약 가능 좌석 조회 요청: 예약 가능 좌석 반환
    예약 가능 좌석 조회 요청 -->>- 사용자: 예약 가능 좌석 반환 
```

## 좌석 예약 요청

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 콘서트 예약 요청: 예약 요청
    콘서트 예약 요청 ->>+ 대기열: 대기열 토큰 검증 (application 전 단계)
    opt 예약 불가능 상태
        대기열 -->>- 사용자: 대기열 검증 실패
    end

    콘서트 예약 요청 ->>+ 콘서트 일정: 콘서트 일정 존재 여부 확인
    opt 콘서트 일정 없음
        콘서트 일정 -->> 사용자: 잘못된 요청
    end

    콘서트 예약 요청 ->>+ 콘서트 좌석: 콘서트 좌석 존재 여부 확인
    opt 콘서트 좌석 없음
        콘서트 좌석 -->> 사용자: 잘못된 요청
    end

    콘서트 예약 요청 ->>+ 예약: 좌석 임시 배정 요청

    예약 ->>+ 예약: 좌석 배정 여부 조회 및 임시 배정
    opt 임시 배정 불가능 상태
        예약 -->>- 사용자: 이미 임시 배정 또는 예약된 좌석
    end

    예약 -->>- 콘서트 예약 요청: OK
    콘서트 예약 요청 ->>+ 대기열: 대기열 토큰 만료 시간 5분 추가
    대기열 -->>- 콘서트 예약 요청: OK
    콘서트 예약 요청 -->>- 사용자: 예약 정보 반환
```

## 잔액 조회

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 잔액 조회 요청: 잔액 조회 요청
    잔액 조회 요청 ->>+ 유저: 유저 정보 검증 (application 전 단계)
    opt 유저 존재하지 않음
        유저 -->>- 사용자: 유저 검증 실패
    end

    잔액 조회 요청 ->>+ 유저 지갑: 잔액 조회
    유저 지갑 -->>- 잔액 조회 요청: 잔액 반환
    잔액 조회 요청 -->>- 사용자: 잔액 반환
```

## 잔액 충전

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 잔액 충전 요청: 잔액 충전 요청
    잔액 충전 요청 ->>+ 유저: 유저 정보 검증 (application 전 단계)

    opt 유저 존재하지 않음
        유저 -->>- 사용자: 유저 검증 실패
    end

    잔액 충전 요청 ->>+ 유저 지갑: 잔액 충전
    유저 지갑 -->>- 잔액 충전 요청: OK
    잔액 충전 요청 -->>- 사용자: OK
```

## 결제

```mermaid
sequenceDiagram
    autonumber
    actor 사용자
    사용자 ->>+ 결제 요청: 결제 요청
    결제 요청 ->>+ 대기열: 대기열 토큰 검증 (application 전 단계)
    opt 예약 불가능 상태
        대기열 -->>- 사용자: 대기열 검증 실패
    end

    결제 요청 ->>+ 예약: 좌석 임시 배정 여부 확인
    opt 좌석 임시 배정 상태가 아님
        예약 -->> 사용자: 좌석 임시 배정 만료
    end

    결제 요청 ->>+ 콘서트: 콘서트 가격 확인
    콘서트 -->>- 결제 요청: 콘서트 가격 반환
    결제 요청 ->>+ 결제: 결제 요청
    결제 ->>+ 유저 지갑: 잔액 차감 요청
    opt 잔액 부족
        유저 지갑 -->> 사용자: 잔액 부족
    end

    유저 지갑 ->> 유저 지갑: 잔액 차감
    유저 지갑 -->>- 결제: OK
    결제 ->>+ 결제: 결제 처리 및 정보 저장
    결제 -->>- 결제 요청: 결제 정보 반환
    결제 요청 ->>+ 예약: 좌석 소유권 배정
    예약 -->>- 결제 요청: OK
    결제 요청 ->>+ 대기열: 대기열 토큰 만료 처리
    대기열 -->>- 결제 요청: OK
    결제 요청 -->>- 사용자: 결제 정보 반환
```