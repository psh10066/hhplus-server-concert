# 프로젝트 및 테스트 코드 설명

## 프로젝트 흐름

- 유저가 잔액을 조회하거나 충전하는 것은 대기열 전후 언제나 수행할 수 있습니다.
- 유저가 대기열 토큰 발급 API를 활성화된 토큰을 받을 때까지 반복적으로 API 요청을 수행합니다.
  - 스케줄러를 통해 10초에 한 번씩 토큰을 활성화 시킵니다. (최대 활성화 개수 : 200개)
- 대기열 토큰이 활성화되면, 이를 이용하여 콘서트 목록 조회 > 예약 가능 날짜 조회 > 예약 가능 좌석 조회의 순으로 API 요청을 수행합니다.
- 좌석 예약 요청 API를 통해 좌석을 임시로 배정합니다. 
  - 5분 내에 결제를 하지 않으면 예약은 만료됩니다.
- 결제 API를 통해 결제를 완료하여 예약을 확정합니다.
  - 결제 완료 시 대기열 토큰은 만료됩니다.

## 참고 사항

- 로컬에서 최초 Application 실행 시, 필요한 초기 테스트 데이터들이 자동으로 삽입되도록 적용되어 있습니다.
  - userId가 1인 User 및 UserWallet
  - 10개의 Concert 및 각 Concert에 대한 3개의 ConcertSchedule
  - 기본 요구사항인 콘서트별 1~50 까지의 좌석 번호를 가지는 ConcertSeat
  - `TestDataSetRunner.kt` 참고
- API에 필요한 userId 혹은 token은 헤더로 주입받아 MethodArgumentResolver를 통해 검증 절차를 거칩니다.
  - Spring Security의 Principal 개념과 비슷한 목적으로 구현하였으며, UserInfo 객체 혹은 QueueInfo 객체가 Controller의 method argument로 존재하는 경우 자동으로 검증과 주입이 수행됩니다.
- 여러 도메인의 로직이 필요한 경우 Facade, 그렇지 않은 경우 Service를 Controller가 호출합니다.
  - 대부분의 단순한 조회 로직 혹은 해당 도메인 내에서만 필요한 로직은 Service 자체적으로 수행이 가능하고, 트랜잭션 관리도 자체적으로 수행됩니다.
    - 이에 따라 Service 패키지는 domain 내에서 중립적인 패키지로 구성되어 있습니다.
  - 필요한 경우 해당 Service의 메서드들을 조립하는 형태로 Facade를 구현합니다.
- 대기열 토큰 API 사용 관련
  - 프로젝트 요구사항 > 유저 대기열 토큰 기능 API 스펙 내에 "이후 모든 API 는 위 토큰을 이용해 대기열 검증을 통과해야 이용 가능"하다는 요구사항이 명세되어 있습니다.
  - 예약 시스템 흐름 상 대기열에 진입하기 전에 유저의 잔고를 조회하거나 충전하는 것은 가능하기 때문에, 잔고 조회 및 충전은 대기열 토큰 발급 "이후" 로 보지 않을 수 있어 userId를 사용하는 방향으로 구현하였습니다.
  - 멘토링 시 결제 API는 대기열 목적 상 토큰을 사용하지 않는 것이 좋을 수 있다는 말씀에 공감하였으나, 요구사항 상 결제는 명확히 대기열 토큰 발급 "이후"로 판단하여 토큰을 사용하는 것으로 구현하였습니다.

## 테스트 코드

- 공통
  - 시간 관련 동작의 경우 LocalDateTime.now 시 Clock을 주입받도록 구현하고, Clock을 mocking하여 테스트 코드를 작성합니다.
  - Test Fixture는 Instancio 라이브러리를 통해 생성합니다.
- Controller : 통합 테스트
  - Controller에서는 MethodArgumentResolver의 정상 동작 및 E2E 테스트의 개념으로 통합 테스트를 수행합니다.
  - 테스트 코드 수행에 성공하면 이를 기반으로 API 문서를 자동으로 생성하도록 설정되어 있습니다.
- Service : 단위 테스트 (필요시 통합 테스트)
  - Service에서는 주요 비즈니스 로직에 대해 단위 테스트를 중점적으로 수행합니다.
  - 동시성 테스트 등 필요한 경우 통합 테스트를 수행합니다.
- Repository : 통합 테스트
  - Repository에서는 JPA 및 QueryDSL 기반의 쿼리 테스트를 운영 환경과 동일한 DB 환경을 Testcontainer를 통해 구성하여 쿼리 테스트를 수행합니다.
  - JPA 자체적으로 생성된 간단한 쿼리보다는 직접 작성한 복잡한 쿼리에 대해 테스트를 중점적으로 수행합니다.
- Domain Model : 단위 테스트
  - Domain Model에서는 각 도메인 모델의 고유 로직에 대해 단위 테스트를 중점적으로 수행합니다.
- MethodArgumentResolver : 단위 테스트
  - MethodArgumentResolver에서는 헤더를 통한 값 검증 및 주입 로직에 대해 단위 테스트를 수행합니다.